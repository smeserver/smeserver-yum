diff -Nur -x '*.orig' -x '*.rej' smeserver-yum-1.1.0/root/sbin/e-smith/yum_update_dbs mezzanine_patched_smeserver-yum-1.1.0/root/sbin/e-smith/yum_update_dbs
--- smeserver-yum-1.1.0/root/sbin/e-smith/yum_update_dbs	2005-06-09 18:49:49.000000000 +1000
+++ mezzanine_patched_smeserver-yum-1.1.0/root/sbin/e-smith/yum_update_dbs	2005-06-09 18:44:51.000000000 +1000
@@ -20,21 +20,27 @@
 
 use strict;
 use esmith::ConfigDB;
+use Proc::PID_File;
 
 my $db = esmith::ConfigDB->open_ro or die "Couldn't open ConfigDB\n";
 
-my $yum_flag = '/var/lock/subsys/yum';
+use constant YUM_CRON_FLAG => '/var/lock/subsys/yum';
+
+use constant YUM_PID => '/var/run/yum.pid';
 
 if ($db->get_prop('yum', 'AutoInstallUpdates') eq 'enabled')
 {
-    (system('/bin/touch', $yum_flag) == 0) or 
-	warn "Couldn't touch $yum_flag\n";
+    (system('/bin/touch', YUM_CRON_FLAG) == 0) or 
+	warn "Couldn't touch " . YUM_CRON_FLAG . "\n";
 }
 else
 {
-    unlink $yum_flag;
+    unlink YUM_CRON_FLAG;
 }
 
+die "$0: Another yum process is running\n" if hold_pid_file(YUM_PID);
+
+
 # XXX - WARNING - XXX
 #
 # For speed and to reduce log noise, we don't use 
@@ -67,7 +73,7 @@
 	print DB "$package=package|Arch|$arch|Repo|$repo|Version|$version\n";
     }
 
-    close YUM;
+    close YUM or die "yum list $list_option failed\n";
 
     open YUM, "-|", YUM_CMD . "grouplist $list_option" or
         die "Couldn't call yum grouplist $list_option\n";
@@ -82,7 +88,7 @@
 
 	print DB "$_=group\n";
     }
-    close YUM;
+    close YUM or die "yum grouplist $list_option failed\n";
 
     close DB;
 
